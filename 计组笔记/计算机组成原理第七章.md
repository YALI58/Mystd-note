
![[计组lv7.m4a]]

7.1.1 输入输出系统和IO控制方式
数据流：键盘->IO接口的数据寄存器->数据总线->CPU寄存器->主存

CPU如何控制键盘IO的完成？
1.程序查询方式：CPU不断轮询检查IO控制器中的“状态寄存器”，检测状态为“已完成”之后，得从数据寄存器取出输入数据。
2.程序中断方式：等待键盘IO时CPU可以先去执行其他程序，键盘IO完成后IO控制器向CPU发出中断请求，CPU响应中断请求，并取走输入数据。
3.DMA控制方式：主存与高速IO设备之间有一条直接数据通路（DMA总线）CPU向DMA接口发出“读写”命令，并指明主存地址，磁盘地址，读写数据量等参数。DMA控制器自动控制磁盘与主存的数据读写，每完成一整块数据读写，才向CPU发出一次中断请求。


通道控制方式：通道可以识别并执行一系列通道指令，通道指令种类，功能比较单一。
![[7.1.1+7.1.2_输入输出系统和IO控制方式PT25M35.735S.webp]]

IO系统由IO软件和IO硬件两部分构成。
1.IO硬件 包括外部设备，IO接口，IO总线
2.IO软件 包括驱动程序，用户程序，管理程序，升级补丁等。‘
通常采用IO指令和通道指令实现主机和IO设备的信息交换。
注：IO指令与普通指令格式略有不同，操作码指明了CPU要对IO接口做什么，命令码指明了IO接口要对设备做什么。

通道指令 通道能识别的指令
通道程序提前编制好放在主存中
通道可以代替CPU对IO设备进行管理。![[7.1.1+7.1.2_输入输出系统和IO控制方式PT31M13.02S.webp]]

7.1.3 外部设备
分辨率 所能表示的像素个数，屏幕上的每一个光点就是一个像素，以宽，高的像素乘积来表示
灰度级    n位可以由2的n次方种不同的亮度或颜色。
刷新    刷新帧率通常在60~120Hz
显示存储器 ：也称刷新存储器，存储容量由分辨率和灰度级来决定。
容量 = 分辨率 * 灰度级位数
带宽 = 分辨率 * 灰度级位数 * 帧频
![[7.1.3_外部设备PT20M0.613S.webp]]

7.2 IO接口
IO接口的作用：
- 数据缓冲：通过数据缓冲寄存器（DBR）达到主机和外设工作速度的匹配。
- 错误或状态监测：通过状态寄存器反馈设备的各种错误，状态信息，供CPU查用
- 控制和定时：接收从控制总线发来的控制信号，时钟信号
- 数据格式交换：串并，并串等格式转换
- 与主机和设备通信：实现 主机-IO接口-IO设备之间的通信![[7.2_IO接口PT3M32.945S.webp]]

内部接口： 内部接口与系统总线相连，实质上是与内存，CPU相连，数据的传输方式可以是串也可以是并。![[7.2_IO接口PT12M10.555S.webp]]

如何确定要操作的设备？
每个设备对应一组寄存器，操作不同的寄存器就是在操作不同的设备。

IO端口及其编址
1.统一编址：
把IO端口当作存储器的单元进行地址分配，用统一的访存指令就可以访问IO端口，又称为存储器映射方式。靠不同地址码区分内存和IO设备，IO地址要求相对固定在地址的某部分。
优点：
不需要专门的输入输出指令，所有访存指令都可直接访问端口，程序设计灵活性高
端口有较大的编址空间，读写控制逻辑电路简单。
缺点：
端口占用主存地址空间，使主存地址空间变小，外设寻址时间长。（地址位数多，地址译码速度慢）
2.独立编址
IO端口地址与存储器地址无关，独立编址CPU需要设置专门的输入输出指令访问端口，又称IO映射方式。’靠不同的指令区分内存和IO设备
优点：使用专用IO指令，程序编制清晰
IO端口地址位数少，地址译码速度快
IO端口的地址不占用主存地址空间
缺点:IO指令类系少，一般只能对端口进行传送操作
程序设计灵活性差
需要CPU提供存储器读写，IO设备读写两组控制信号，增加了控制逻辑电路的复杂性。

IO接口的类系：
按数据传送方式可分为：并行接口，串行接口；
按主机访问IO设备的控制方式可分为 程序查询接口，中断接口，DMA接口。


程序查询方式：
x86中的IO指令实例：
IN Rd ，Rs ； 把IO端口Rs 的数据输入到CPU寄存器Rd
OUT Rd，Rs；把CPU寄存器Rs 的数据输出到IO端口 Rd

![[7.3.1_程序查询方式PT14M20.038S.webp]]

7.3.2 中断的作用和原理
- 中断的基本概念：
- 不同中断需要不同的中断服务程序
- 关中断会使计算机不会理会中断请求信号。

中断的基本概念
程序中断是指计算机执行现行程序的过程中，出现某些急需处理的异常情况或特殊请求，CPU暂时中止现行程序，而转去对这些异常情况或特殊请求进行处理，在处理完毕后CPU又自动返回到允许程序的断点处，继续执行原程序。
工作流程：
1.中断请求
中断源向CPU发送中断请求信号。
2.中断响应
响应判断的条件
中断判优：多个中断源同时提出请求时通过中断判优逻辑响应一个中断源。
3.中断处理
中断隐指令
中断服务程序。

关中断的作用：实现原子操作。在PSW中 IF=1表示开中断 ，IF=0表示关中断 
有些中断，非屏蔽中断，不会受关中断的影响。 

中断请求标记：
如何判断是哪个设备发来的中断信号
中断系统需给每个中断源设置中断请求标记触发器INTR。当其状态为“1” 表示中断源有请求。这些触发器可组成中断请求标记寄存器。CPU是在统一时刻即每次指令执行阶段结束前向接口发出中断查询信号。
CPU响应中断必须满足以下3个条件：
- 中断源有中断请求
- CPU允许中断即开中断
- 一条指令执行完毕，且没有更紧迫的任务

中断判优：
中断判优既可以用硬件实现，也可以用软件实现：
硬件实现是通过硬件排队器实现的，软件实现是通过查询程序实现的。
优先级设置：

![[7.3.2_1_中断的作用和原理PT24M13.625S.webp]]

中断处理过程：
中断隐指令：
- 关中断。在中断服务程序中，为了保护中断现场，期间不必新的中断所打断，必须关中断，从而保证被中断的程序在中断服务程序执行完毕之后能接着正确地执行下去。
- 保存断点。为了保证在中断服务程序执行完毕后能正确返回到原来的程序。
- 引出中断服务程序。引出中断服务程序的实质就是取出中断服务程序的入口地址并传送给程序计数器（PC）；硬件向量法![[7.3.2_1_中断的作用和原理PT32M52.1S.webp]]

中断向量指的是中断服务程序的指针，向量地址指的是中断向量的指针。向量地址->val = 中断向量。

中断服务程序：
![[7.3.2_1_中断的作用和原理PT39M1.608S.webp]]![[7.3.2_1_中断的作用和原理PT42M51.522S.webp]]

7.3.2.2 多重中断
![[7.3.2_2_多重中断PT2M45.436S.webp]]

中断屏蔽技术主要用于多重中断，CPU要具备多重中断的功能，需满足下列条件
- 在中断服务程序中提前设置开中断指令。
- 优先级的中断源有权中断优先级别低的中断源。![[7.3.2_2_多重中断PT5M40.431S.webp]]![[7.3.2_2_多重中断PT14M23.672S.webp]]
7.3.2 程序中断方式
![[7.3.2_3_程序中断方式PT11M23.232S.webp]]7.3.3 DMA 方式
![[7.3.3_DMA方式PT26M42.384S.webp]]![[7.3.3_DMA方式PT25M27.064S.webp]]