# 计算机组成原理 - 第三章 存储系统


## 3.0 数据的存储和排列

### 大小端模式
- 多字节数据在内存中占用连续的字节。
- 字节排列是从右到左，右边是**最低有效字节**，左边是**最高有效字节**。
- 内存地址排列是从左到右。
- **大端模式**：最高有效字节放在低内存地址，适合人类阅读，但不适合计算机处理。
- **小端模式**：最高有效字节放在高内存地址，适合计算机处理。

### 寻址方式
- 现代计算机通常按字节编址，每个字节对应一个地址。
- 支持按**字**（32位）、**半字**（16位）、**字节**寻址。
- 假设存储字长为32位，则一个字=32bit，半字=16bit，每次访存只能读/写1个字。

### 边界对齐
- **边界对齐方式**：会浪费空间，但提升性能。
- **边界不对齐方式**：节省空间，但性能较低。

---

## 3.1 存储系统基本概念

### 存储器的层次化结构
- 辅存中的数据需调入主存后才能被CPU访问。
- 层次结构：**CPU → Cache → 主存 → 辅存**
- 其中，**Cache**和**主存**可被CPU直接读写。

![3.1_存储系统基本概念PT3M51.469S.webp](https://youke1.picui.cn/s1/2025/08/06/689334018f0cb.webp)

### 存储器的分类 - 层次
- **高速缓存 (Cache)**：最快，容量小。
- **主存储器 (主存、内存)**：速度中等，容量中等。
- **辅助存储器 (辅存、外存)**：速度慢，容量大。

### 存储器的分类 - 存取方式
- **随机存取存储器 (RAM)**：读写任意存储单元的时间相同，与物理位置无关。
- **顺序存取存储器 (SAM)**：读写时间取决于存储单元的物理位置。
- **直接存取存储器 (DAM)**：结合随机和顺序存取特性，先选取区域，再按顺序存取。

### 存储器的分类 - 信息的可保存性
- **易失性存储器**（断电后信息消失）：
  - 主存
  - Cache
- **非易失性存储器**（断电后信息保持）：
  - 磁盘
  - 光盘

- **破坏性读出**：
  - 信息读出后，原存储信息被破坏。
  - 例如：**DRAM芯片**（读取后需重写）。
- **非破坏性读出**：
  - 信息读出后，原存储信息不被破坏。
  - 例如：**SRAM芯片**、磁盘、光盘。

### 存储器的性能指标
1. **存储速度**：数据传输率 = 数据的宽度 / 存储周期（数据的宽度即存储字长）。
2. **存取时间**：从启动存储器操作到完成操作的时间，分为读出时间和写入时间。
3. **存取周期**：存储器进行一次完整读写操作所需的时间，即连续两次访问存储器所需的最小时间间隔（存取时间 + 恢复时间）。
4. **主存带宽**：每秒从主存进出信息的最大数量，又称数据传输率。

---

## 3.2 主存储器

### 3.2.0 + 3.2.3 主存储器的基本组成
- 存储字长取决于存储体的长度。
- MOS管可理解为一种电控开关，输入电压达到阈值时接通。
- 读操作是电容放电，写操作是电容存电。

![3.2.0+3.2.3_主存储器的基本组成PT10M11.297S.webp](https://youke1.picui.cn/s1/2025/08/06/6893340168882.webp)

- **MAR (Memory Address Register)**：与CPU和译码器相连，若MAR有n位地址，则有2^n个地址。
- 译码器连接存储体，存储体连接**MDR (Memory Data Register)**。

#### 存储器芯片的基本原理
- **CS (Chip Select) 和 CE (Chip Enable)**：片选信号，控制芯片是否被激活。
- 8x8位存储芯片代表 2^13 x 8bit。

#### 控制电路的功能
- **地址译码**：将CPU发送的地址转换为存储单元的行/列位置（如DRAM的RAS行选通、CAS列选通）。
- **读写控制**：
  - 读操作：使能输出缓冲器，将数据从存储单元传至数据线。
  - 写操作：锁存输入数据，写入指定存储单元。
- **刷新控制**（DRAM专用）：定期对存储单元进行电荷刷新，防止数据丢失。
- **时序管理**：生成时钟同步信号（如CLK），控制预充电时间（tRP）等时序参数。

#### 典型电路组成
1. **地址缓冲器**：接收并暂存地址总线信号。
2. **行列译码器**：分解行/列地址，选中目标存储单元。
3. **读写放大器**：放大存储单元的微弱电信号（如DRAM的1T1C结构）。
4. **刷新计数器**：按周期生成刷新地址（DRAM每64ms需刷新全部行）。
5. **模式寄存器**：配置突发长度、延迟参数（如DDR4的CL值）。

#### 示例对比
| 存储器类型       | 控制电路特性                          |
|------------------|---------------------------------------|
| **SRAM**         | 无需刷新电路，直接通过字线/位线读写   |
| **DRAM**         | 需刷新电路，行列地址分时复用          |
| **NAND Flash**   | 需ECC纠错和磨损均衡算法              |

---

### 3.2.1 SRAM和DRAM
- **DRAM (Dynamic RAM)**：用于主存，采用栅极电容存储信息。
- **SRAM (Static RAM)**：用于Cache，采用双稳态触发器存储信息。
- 核心区别在于存储元不同。

#### 栅极电容 vs 双稳态触发器
![3.2.1_SRAM和DRAMPT5M51.392S.webp](https://youke1.picui.cn/s1/2025/08/06/689334014e392.webp)]]
- **字选择线**：译码器与存储体连接的线，用于读写数据。
- **栅极电容**：MOS管接通后，电容有电为1，无电为0。
- **双稳态触发器**：A高B低为1，A低B高为0。读出0时BL为低电平，读出1时BLX为低电平；写入0时给BLX高电位、BL低电位，写入1类似。

#### 读出特性
- **栅极电容**：电容放电导致信息破坏，属于破坏性读出，读出后需重写（再生）。
- **双稳态触发器**：读出数据后状态稳定，属于非破坏性读出，无需重写。

#### 信息保持
- **栅极电容**：信息只能维持约2ms。
- **双稳态触发器**：只要不断电，状态就不会改变。

#### DRAM的刷新
1. **刷新频率**：一般每2ms刷新一次。
2. **刷新单位**：以行为单位，每次刷新一行存储单元。
3. **行列地址的好处**：
   - 减少地址引脚数量，降低硬件复杂度。
   - 提高存储密度，降低成本。
   - 兼容刷新操作。
   ![3.2.1_SRAM和DRAMPT15M21.668S.webp](https://youke1.picui.cn/s1/2025/08/06/6893340187650.webp)
- **SRAM**：通常无需行列地址，采用静态触发器结构，访问速度快但密度低，引脚数多（适合小容量缓存）。
4. **刷新方式**：由硬件支持，读出一行信息后重新写入，占用1个读写周期。
5. **刷新时机**：
   - 假设DRAM内部结构为128x128，存取周期0.5微秒，2ms内有4000个周期。
   - **思路一**：每次读写完刷新一行，系统存取周期变为1微秒（前0.5微秒正常读写，后0.5微秒刷新）。
   - **思路二**：集中刷新，存取周期仍为0.5微秒，但有一段时间专门刷新，无法访问存储器（访存“死区”）。
   - **思路三**：异步刷新，2ms内每行刷新一次，每隔2ms/128=15.6微秒产生一次刷新请求。

---

### 3.2.2 只读存储器 (ROM)
- **掩膜式只读存储器 (MROM)**：存储内容由制造厂按用户要求在生产时写入，无法修改。
- **一次可编程只读存储器 (PROM)**：用户通过编程器一次性写入，之后不可修改。
- **可擦除可编程只读存储器 (EPROM)**：支持有限次修改，但写入时间较长。
- **闪速存储器 (Flash Memory)**：如U盘，写入速度较快（需先擦除）。
- **固态硬盘 (SSD)**：由控制单元+Flash芯片组成。

#### 关键注意事项
1. 部分ROM虽标为“Read-Only”，但实际支持写入（如Flash）。
2. 闪存的写速度通常慢于读速度（因需先擦除）。
3. RAM是易失性的，ROM是非易失性的，但许多ROM也支持随机存取。

---

### 3.2.4 双端口RAM和多模块存储器

- **存取周期**：可以连续读/写的最短时间间隔。
- 注：**DRAM芯片**的恢复时间比较长，有可能是存取时间的几倍（**SRAM**的恢复时间较短）。
- 如：存取时间为 **r**，存取周期为 **T**，T=4r。
- 多核CPU都要访存，怎么办？CPU的读写时间比主存快很多，主存恢复时间太长怎么办？

#### 提升主存速度
- 多核CPU使用**双端口RAM**解决，CPU速度远快于主存问题由**多模块存储器**解决。

#### 双端口RAM
- 需要有两组完全独立的数据线、地址线、控制线，CPU、RAM中也要有更复杂的控制电路。
- 两个端口对同一个主存操作有4种情况：
  1. 可在不同的地址单元存取数据。
  2. 可对同一地址单元读出数据。
  3. 不能同时写一块地址单元。
  4. 不能对一个地址单元，一个写，一个读。
- 解决方法：置忙信号为0。

#### 多体并行存储器
![3.2.4 双端口RAM和多模块存储器PT16M3.623S.webp](https://youke1.picui.cn/s1/2025/08/06/689334019031d.webp)
- **高位交叉编址**：有n根内存条就有log n位作为编号。这导致当连续访问时，必须要等前一个存取周期结束。连续取n个存储字耗时nT。
- **低位交叉编址**：地址连续分布在不同的内存条，当连续访问时，可以快速访问。耗时T+4r，连续取n个存储字耗时T+(n-1)r。
- 存取周期为**T**，存取时间为**r**，为了使流水线不间断，应保证模块数**m>=T/r**。
- 哪里编址就在那里编号。

---

## 3.3 主存储器与CPU的连接
- **CS**上有横线是低电平有效。
- 增加主存的存储字长-位扩展：8片8KX1位的存储芯片->一个8kX8位的存储器，容量8KB。

### 增加主存的存储字数-字扩展
- **线选线**：A13,A14链接存储器的**CS**，A14，A13只能为01或10。
  - 最低地址：01000，最高地址：011111
  - 最低地址：10000，最高地址：101111
  - 由于A14，A13只能为01或10，内存地址不连续。
- 或者1-2译码器来链接：
  - 最低地址：10000，最高地址：1111111
  - 最低地址：00000，最高地址：0111111
  - 这样地址是存储芯片的内存地址是连续的。
- 译码器选法，有n条线就有2^n选片信号。

### 主存容量拓展-字扩展
- **线选法**：n条线->n个选片信号，电路简单，地址空间不连续。
- **译码片选法**：n条线->2^n片选信号，电路复杂，地址空间连续。

---

## 3.4.1 磁盘存储器

### 磁盘设备的组成
1. **存储区域**：一块硬盘含有若干个记录面，每个记录面划分为若干条磁道，而每个磁道又分为若干个扇区，扇区（也称块）是磁盘读写的最小单位，也就是说磁盘按块存取。
2. **磁头数**：即记录面数，表示硬盘总共有多少个磁头，一个记录面对应一个磁头。
3. **柱面数**：表示硬盘的每一面盘片上有多少条磁道。
4. **扇区数**：表示每一条磁道上有多少扇区。

### 磁盘的性能指标1
1. **磁盘的容量**：一个磁盘所能存储的字节总数称为磁盘容量。磁盘容量有非格式化容量和格式化容量之分。
2. **记录密度**：记录密度是指盘片单位面积上记录的二进制的信息量，通常以道密度、位密度和面密度表示。
   - **道密度**是沿半径方向单位长度上的磁道数。
   - **位密度**是磁道单位长度能记录的二进制代码位数。
   - **面密度**是位密度和道密度的乘积。
- 注意：磁盘所有磁道记录的信息量一定是相等的，并不是圆越大信息越多，故每个磁道的位密度都不同。

### 性能指标2
- **平均存取时间**：寻道时间（磁头移动到目的磁道）+旋转延迟时间（磁头定位到所在扇区）+传输时间（传输数据所花费的时间）。

![3.4.1_磁盘存储器PT20M52.748S.webp](https://youke1.picui.cn/s1/2025/08/06/6893346e092c5.webp)

### 性能指标3
- **数据传输率**：磁盘存储器在单位时间内向主机传送数据得到的字节数，称为数据传输率。
- 假设磁盘转数为**r**（转/秒），每条磁道容量为**N**个字节，则数据传输率为**D=r*N**。

### 磁盘存储器的工作流程
- 磁盘的主要操作是寻址、读盘、写盘。硬盘工作时，第一步是取控制字，第二步是执行控制字。硬盘属于机械式部件，其读写操作时串行的。

### 磁盘阵列
- **RAID**：是将多个独立的物理磁盘组成一个独立的逻辑盘，数据在多个物理盘上分割交叉存储、并行访问，具有更好的存储性能、可靠性和安全性。

---

## 3.4.2 固态硬盘SSD
- 每个芯片分为m个块，每个块分为n个页。

### SSD（固态硬盘）核心技术解析

#### 一、基本结构与原理
- **存储介质**：基于闪存技术（**Flash Memory**），属于电可擦除ROM（**EEPROM**）。
- **核心组件**：
  - **闪存翻译层（FTL）**：
    - 负责将逻辑块号（**LBA**）翻译为物理页地址（**PBA**）。
    - 通过电路快速定位物理地址，支持随机访问。
  - **存储单元层次**：
    ```mermaid
    graph TD
    SSD --> Flash_Chip(闪存芯片)
    Flash_Chip --> Block(块)
    Block --> Page(页)
    ```

#### 二、读写特性
| **操作** | **单位** | **特点**                              |
|----------|----------|---------------------------------------|
| 读       | 页       | 速度快（μs级），可无限次读取           |
| 写       | 页       | 需空白页，否则需整块擦除后写入（慢）    |
| 擦除     | 块       | 必须整块擦除后才能重新写入              |

#### 三、关键优化技术
##### 1. 磨损均衡（Wear Leveling）
- **动态磨损均衡**：
  - 写入时优先选择擦除次数少的块。
- **静态磨损均衡**：
  - 自动迁移数据，让新块承担写操作，旧块承担读操作。

---

## 3.5.1 + 3.5.2 Cache的基本原理
- **Cache**被集成CPU里，缓和了速度矛盾。

### 局部性原理
- **空间局部性**：未来使用的数据，很可能与现在正在使用的信息在存储空间上是临近的。
- **时间局部性**：未来要用到的信息，很可能就是现在正在使用的信息，循环结构的指令代码。

- 基于局部性原理，不难想到，可以把CPU目前访问的地址“周围”的部分数据放到**Cache**中。
- 空间局部性：指令和数据地址相邻，时间局部性：使用的指令和数据短时间重复使用。

### Cache的性能分析
- 设**tc**为访问一次Cache所需时间，**tm**为访问一次主存所需时间。
- **命中率H**：CPU欲访问的信息已在Cache中的比率。
- **缺失率M**：1-H。
- **t=H*tc+(1-H)(tc+tm)** 或 **t=Htc+(1-H)tm**。

- 基于局部性原理，不难想到，可以把CPU目前访问的地址“周围”的部分数据放到**Cache**中，如何界定周围？
- 将主存的存储空间“分块”，每1KB为一块，主存与**Cache**之间以“块”为单位进行数据交换。

### 三个问题有待解决
1. 如何区分**Cache**与主存的数据块对应关系？---**Cache**和主存的映射方式。
2. **Cache**很小，主存很大。如果**Cache**满了怎么办？---替换算法。
3. CPU修改**Cache**中的数据副本，如何确保主存中数据母本的一致性？---**Cache**写策略。

---

## 3.5.3 Cache和主存的映射方式
- 如何区分**Cache**中放的是哪个主存块？给每一个**Cache**块增加一个“标记”，还要增加“有效位”。
1. **全相联映射**：主存块可以放在**Cache**的任意位置。
2. **直接映射**：每个主存块只能放到一个特定的位置：**Cache**块号=主存块号%**Cache**总块数。
3. **组相联映射**：**Cache**块分为若干组，每个主存块可放到特定分组中的任意一个位置，组号=主存块号%分组数。

### 全相联映射如何访存
- 假设某个计算机的主存地址空间大小为256MB，按字节编址，其数据**Cache**有8个**Cache**行，行长为64B。
- CPU访问主存地址：
  1. 主存地址的前22位，对比**Cache**中的所有块的标记。
  2. 若标记匹配且有效位=1，则**Cache**命中，访问块内地址为问为001110的单元。
  3. 若未命中或有效位=0，则正常访问主存。

### 直接映射（只能放固定位置）
- 直接映射，主存块在**Cache**中的位置=主存块号%**Cache**总块数。
- 优化标记，留下log（**Cache**总块数）位。

- 组相联映射与直接映射相差不大。

---

## 3.5.4 Cache替换算法
- **全相联映射**：
  - **Cache**完全满了才需要替换，需要在全局选择替换那一块。
- **直接映射**：
  - 如果对应位置非空，则毫无选择的直接替换。
- **组相联映射**：
  - 分组满了才需要替换，需要在分组内决定替换那一块。

### 先进先出算法
- 若**Cache**已满，则替换最先被调入**Cache**的块。实现简单，最开始调入的顺序就是替换顺序，**FIFO**没有考虑局部性原理，最先被调入**Cache**块也有可能是被频繁访问的。

### 近期最少使用算法（LRU）
- 为每一个**Cache**块设置一个“计数器”，用于记录每一个**Cache**块已经多久没被访问了。当**Cache**满后替换“计数器”最大的。
- 计数器只需 log（**Cache**块的总数）位。
1. 命中时，所命中的行的计数器清零，比其低的计数器加1，其余的不变。
2. 未命中且还有空闲行时，新装入的行的计数器置0，其余非空闲行全加1。
3. 未命中且无空闲行时，计数值最大的行的信息块被淘汰，新装入的块的计数器置0，其余全加1。

### 最不经常使用算法
- 计数器记录每个**Cache**块被访问过几次。当**Cache**满后替换最小的。

---

## 3.5.5 Cache写策略

- **写命中的写回法**：写回法会先修改**Cache**的，当**Cache**块被替换才会写入主存。
- **写命中的全写法**：本来效率很慢但是利用写缓冲可提升。
- **写不命中得到的写分配法**：通常与写回法搭配，写分配法---当CPU对**Cache**写不命中时，把主存中的块调用**Cache**，在**Cache**中修改。通常搭配写回法。
- **写不命中的非写分配法**：当CPU对**Cache**写不命中时只写入主存，不调入**Cache**，搭配全写法使用。

### 多级Cache
- 各级**Cache**之间常采用“全写法+非写分配法”，**Cache**-主存之间常采用“写回法和写分配法”。

---
